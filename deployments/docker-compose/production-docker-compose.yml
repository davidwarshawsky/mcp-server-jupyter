# MCP Jupyter Server - Production Docker Compose
# IIRB Mode C Compliant
# Last Updated: 2025-01-20

version: '3.8'

services:
  mcp-jupyter:
    image: mcp-jupyter:0.2.1
    container_name: mcp-jupyter-prod
    restart: always
    
    # Security Options (IIRB P0 Fixes #3 & #4)
    security_opt:
      - no-new-privileges:true
      - seccomp:${PWD}/seccomp-profile.json
      - apparmor:mcp-jupyter
    
    # Capabilities (IIRB P0 Fix #3)
    cap_drop:
      - ALL
    cap_add:
      - CHOWN  # Only capability needed (pip installs)
      # SETUID/SETGID explicitly NOT added
    
    # Read-only root filesystem
    read_only: true
    
    # Tmpfs mounts (writable temporary directories)
    tmpfs:
      - /tmp:size=1G,mode=1777,noexec,nosuid,nodev
      - /home/jupyter/.cache:size=2G,noexec,nosuid,nodev
    
    # Persistent volumes (IIRB P0 Fix #2)
    volumes:
      - mcp-data:/var/mcp-jupyter:rw
      - ./workspace:/workspace:rw
    
    # Environment Variables (IIRB Mode C Compliant)
    environment:
      # Server
      - MCP_HOST=0.0.0.0
      - MCP_PORT=3000
      - LOG_LEVEL=INFO
      
      # Persistence (12-Factor App)
      - MCP_DATA_DIR=/var/mcp-jupyter
      
      # Security (IIRB Mode C)
      - MCP_STRICT_MODE=1
      - MCP_SESSION_TOKEN=${MCP_SESSION_TOKEN}  # Set in .env file
      - MCP_PACKAGE_ALLOWLIST=pandas,numpy,scikit-learn,matplotlib,seaborn
      - MCP_ALLOWED_ROOT=/workspace
      
      # Resource Limits
      - MCP_MAX_KERNELS=10
      - MCP_MEMORY_LIMIT_BYTES=8589934592  # 8 GB
      - MCP_IO_POOL_SIZE=4
      
      # Asset Management
      - MCP_ASSET_MAX_AGE_HOURS=24
      
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - OTEL_SERVICE_NAME=mcp-jupyter-prod
    
    # Resource Limits
    mem_limit: 16g
    memswap_limit: 16g  # No swap
    mem_reservation: 8g
    cpus: 4.0
    pids_limit: 512  # Prevent fork bombs
    
    # Network
    networks:
      - backend
    
    ports:
      - "3000:3000"
    
    # User
    user: "1000:1000"
    
    # Health Check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service,environment"
    
    labels:
      - "com.example.service=mcp-jupyter"
      - "com.example.environment=production"
      - "com.example.version=0.2.1"

  # Observability Stack (optional)
  jaeger:
    image: jaegertracing/all-in-one:1.50
    container_name: jaeger
    restart: always
    
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    
    ports:
      - "16686:16686"  # Jaeger UI
      - "4318:4318"    # OTLP HTTP
    
    networks:
      - backend
    
    volumes:
      - jaeger-data:/tmp
    
    mem_limit: 2g
    cpus: 1.0

networks:
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  mcp-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data  # Create this directory: mkdir -p ./data
  
  jaeger-data:
    driver: local

# Security Notes:
# 1. Create .env file with: MCP_SESSION_TOKEN=$(openssl rand -hex 32)
# 2. Create seccomp-profile.json (see SECURITY.md)
# 3. Load AppArmor profile: sudo apparmor_parser -r apparmor-profile
# 4. Set file permissions: chmod 600 .env
