# GitHub Actions: Publish mcp-server-jupyter to PyPI
# Triggered on: git push v*.*.* (semantic version tags)
# 
# [IIRB REMEDIATION] Automated CI/CD release pipeline
# - Removes manual `publish.sh` on developer laptop
# - Ensures deterministic, reproducible releases via CI
# - Enforces all releases go through automated testing

name: Publish to PyPI

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Build package
        working-directory: ./tools/mcp-server-jupyter
        run: poetry build
      
      - name: Publish to TestPyPI (validation)
        working-directory: ./tools/mcp-server-jupyter
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.POETRY_PYPI_TOKEN_TESTPYPI }}
        run: |
          poetry config repositories.testpypi https://test.pypi.org/legacy/
          poetry publish -r testpypi --skip-existing || echo "Already published to TestPyPI"
      
      - name: Publish to Production PyPI
        working-directory: ./tools/mcp-server-jupyter
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.POETRY_PYPI_TOKEN_PYPI }}
        run: poetry publish --skip-existing
      
      - name: Create Release Notes
        run: |
          echo "## Release ${{ github.ref_name }}" > release.md
          echo "" >> release.md
          echo "âœ… Automatically published to PyPI via CI/CD" >> release.md
          echo "" >> release.md
          echo "Install with:" >> release.md
          echo "\`\`\`bash" >> release.md
          echo "pip install mcp-server-jupyter==${{ github.ref_name }}" >> release.md
          echo "\`\`\`" >> release.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release.md
          files: ./tools/mcp-server-jupyter/dist/*
