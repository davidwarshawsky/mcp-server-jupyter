bringing up nodes...
bringing up nodes...

........................................................s............... [ 11%]
........................................................................ [ 22%]
........................................................................ [ 33%]
.................................................................s...... [ 45%]
........................................................................ [ 56%]
........................................................................ [ 67%]
......s.......F.................F........................s..sF.......... [ 79%]
.......F................................................................. [ 90%]
.............s....F.F.FF....s.FFF..F......Transient error StatusCode.UNAVAILABLE encountered while exporting traces to localhost:4317, retrying in 1.14s.
..Transient error StatusCode.UNAVAILABLE encountered while exporting traces to localhost:4317, retrying in 2.20s.
.F.Failed to export traces to localhost:4317, error code: StatusCode.UNAVAILABLE
............              [100%]Transient error StatusCode.UNAVAILABLE encountered while exporting metrics to localhost:4317, retrying in 0.97s.
Transient error StatusCode.UNAVAILABLE encountered while exporting metrics to localhost:4317, retrying in 1.06s.
Failed to export metrics to localhost:4317, error code: StatusCode.DEADLINE_EXCEEDED
Failed to export metrics to localhost:4317, error code: StatusCode.DEADLINE_EXCEEDED

=================================== FAILURES ===================================
__________ TestSmallHTMLTablePreview.test_convert_pandas_style_table ___________
[gw2] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

self = <tests.test_security_fixes.TestSmallHTMLTablePreview object at 0x7b3d2e9d1b80>

    def test_convert_pandas_style_table(self):
        """Test with actual pandas HTML structure."""
        # Simplified pandas HTML
        html = """
        <table border="1" class="dataframe">
          <thead>
            <tr style="text-align: right;">
              <th>A</th>
              <th>B</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>2</td>
            </tr>
            <tr>
              <td>3</td>
              <td>4</td>
            </tr>
          </tbody>
        </table>
        """
        result = _convert_small_html_table_to_markdown(html)
    
        assert result is not None
>       assert "A" in result and "B" in result
E       AssertionError: assert ('A' in '| 1 | 2 |\n| --- | --- |\n| 3 | 4 |')

tests/test_security_fixes.py:160: AssertionError
___________________________ test_cwd_is_notebook_dir ___________________________
[gw6] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

session_manager_fixture = <src.session.SessionManager object at 0x7153bb623da0>
temp_notebook = '/tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb'

    @pytest.mark.asyncio
    async def test_cwd_is_notebook_dir(session_manager_fixture, temp_notebook):
        manager = session_manager_fixture
        await manager.start_kernel(temp_notebook)
    
        # code to check cwd
        code = "import os; print(os.getcwd())"
        exec_id = await manager.execute_cell_async(temp_notebook, 0, code)
    
        final_status = None
        for _ in range(60):  # Increased to account for parallel execution load
            await asyncio.sleep(0.5)
            status = manager.get_execution_status(temp_notebook, exec_id)
            if status["status"] == "completed":
                final_status = status
                break
    
        assert final_status is not None
        # We expect the CWD to be the directory of possible notebook
        expected_dir = str(Path(temp_notebook).parent.resolve())
        # Normalize slashes for comparison
        output_clean = final_status["output"].strip().replace("\\", "/")
        expected_clean = expected_dir.replace("\\", "/")
    
        # The output might print it somewhat differently (case sensitivity on Windows), but let's check basic containment
>       assert expected_clean.lower() in output_clean.lower()
E       assert '/tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks' in '{"llm_summary": "", "raw_outputs": []}'
E        +  where '/tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks' = <built-in method lower of str object at 0x7153bb6514b0>()
E        +    where <built-in method lower of str object at 0x7153bb6514b0> = '/tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks'.lower
E        +  and   '{"llm_summary": "", "raw_outputs": []}' = <built-in method lower of str object at 0x7153bb634f30>()
E        +    where <built-in method lower of str object at 0x7153bb634f30> = '{"llm_summary": "", "raw_outputs": []}'.lower

tests/test_comprehensive_async.py:137: AssertionError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:14:55 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:14:55 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:14:55 [info     ] [KERNEL] Assigning UUID: f7a61783-d535-45e1-84a8-73ba43a5a521
2026-01-25 18:14:56 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb cwd=/tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks docker=False env=system
2026-01-25 18:14:57 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb
2026-01-25 18:14:57 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb
Waiting for status change on 65319c75-8da6cfdd192fcd3a9a73c5b5_15810_4 with timeout=300
2026-01-25 18:14:57 [debug    ] Buffering IOPub msg (type=status parent_id=65319c75-8da6cfdd192fcd3a9a73c5b5_15810_2) - known exec keys: ['65319c75-8da6cfdd192fcd3a9a73c5b5_15810_4'] (len=1)
2026-01-25 18:14:57 [debug    ] Buffering IOPub msg (type=stream parent_id=65319c75-8da6cfdd192fcd3a9a73c5b5_15810_2) - known exec keys: ['65319c75-8da6cfdd192fcd3a9a73c5b5_15810_4'] (len=1)
Finalizing 65319c75-8da6cfdd192fcd3a9a73c5b5_15810_4 status=completed cell_index=0
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 3be224dc-636c-4baa-8c3a-ae1332b6e18b
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb (PID: 16655)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:14:59 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb
2026-01-25 18:14:59 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw6/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb
__________ TestHTMLTableIntegration.test_small_dataframe_shows_inline __________
[gw2] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

self = <tests.test_security_fixes.TestHTMLTableIntegration object at 0x7b3d2e9d1ee0>
tmp_path = PosixPath('/tmp/pytest-of-david/pytest-124/popen-gw2/test_small_dataframe_shows_inl0')

        @pytest.mark.asyncio
        async def test_small_dataframe_shows_inline(self, tmp_path):
            """Small DataFrames should display as markdown tables."""
            pytest.importorskip("pandas")
    
            manager = SessionManager()
            nb_path = tmp_path / "test_table.ipynb"
    
            # Create notebook
            nb = nbformat.v4.new_notebook()
            nb.cells.append(nbformat.v4.new_code_cell("import pandas as pd"))
            with open(nb_path, "w") as f:
                nbformat.write(nb, f)
    
            try:
                await manager.start_kernel(str(nb_path))
    
                # Create small DataFrame
                code = """
    import pandas as pd
    df = pd.DataFrame({'A': [1, 2, 3], 'B': [4, 5, 6]})
    df.head()
    """
                result = await manager.run_simple_code(str(nb_path), code)
    
                # Should contain markdown table (Data Preview) if HTML conversion worked
                # OR fallback message if conversion failed
>               assert "[Data Preview]" in result or "[HTML Table detected" in result
E               assert ('[Data Preview]' in '{"llm_summary": "", "raw_outputs": []}' or '[HTML Table detected' in '{"llm_summary": "", "raw_outputs": []}')

tests/test_security_fixes.py:194: AssertionError
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:14:58 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:14:58 [info     ] IOMultiplexer initialized (input_timeout=60s)
2026-01-25 18:14:58 [info     ] [KERNEL] Assigning UUID: 0b0d61f6-ad9b-4769-9a32-73d87a5b9bef
2026-01-25 18:14:58 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-124/popen-gw2/test_small_dataframe_shows_inl0/test_table.ipynb cwd=/tmp/pytest-of-david/pytest-124/popen-gw2/test_small_dataframe_shows_inl0 docker=False env=system
2026-01-25 18:15:01 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-124/popen-gw2/test_small_dataframe_shows_inl0/test_table.ipynb
2026-01-25 18:15:01 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-124/popen-gw2/test_small_dataframe_shows_inl0/test_table.ipynb
Waiting for status change on 42265c82-0ef462dad84b3c9f6e37ecba_15793_4 with timeout=300
2026-01-25 18:15:01 [debug    ] Buffering IOPub msg (type=status parent_id=42265c82-0ef462dad84b3c9f6e37ecba_15793_2) - known exec keys: ['42265c82-0ef462dad84b3c9f6e37ecba_15793_4'] (len=1)
2026-01-25 18:15:01 [debug    ] Buffering IOPub msg (type=stream parent_id=42265c82-0ef462dad84b3c9f6e37ecba_15793_2) - known exec keys: ['42265c82-0ef462dad84b3c9f6e37ecba_15793_4'] (len=1)
Finalizing 42265c82-0ef462dad84b3c9f6e37ecba_15793_4 status=completed cell_index=-1
2026-01-25 18:15:01 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw2/test_small_dataframe_shows_inl0/test_table.ipynb
------------------------------ Captured log call -------------------------------
WARNING  traitlets:client.py:125 Could not destroy zmq context for <jupyter_client.asynchronous.client.AsyncKernelClient object at 0x7b3d2c1d0920>
WARNING  traitlets:client.py:125 Could not destroy zmq context for <jupyter_client.asynchronous.client.AsyncKernelClient object at 0x7b3d2c1d2de0>
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 7b9cc485-9bfc-4b64-b0b8-9252fa876216
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw2/test_small_dataframe_shows_inl0/test_table.ipynb (PID: 16816)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:15:01 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw2/test_small_dataframe_shows_inl0/test_table.ipynb
_______________ test_end_to_end_asset_extraction_and_provenance ________________
[gw1] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0')
real_session_manager = <src.session.SessionManager object at 0x7aeffc177fb0>

    @pytest.mark.asyncio
    @pytest.mark.optional
    async def test_end_to_end_asset_extraction_and_provenance(
        tmp_path, real_session_manager
    ):
        """
        Validates:
        1. Kernel starts in correct environment
        2. Matplotlib imports work
        3. PNG images are extracted to assets/ directory
        4. Cell metadata contains provenance (timestamp, env_name, python_path)
    
        Note: This test is marked as 'optional' because it requires matplotlib and numpy.
        Run with: pytest -m optional
        """
        # 1. Create a test notebook
        nb_path = tmp_path / "test_assets.ipynb"
        notebook.create_notebook(str(nb_path))
    
        # 2. Start kernel
        start_result = await real_session_manager.start_kernel(str(nb_path))
        assert "Kernel started" in start_result
    
        # 3. Check if matplotlib is available, skip if not
        check_code = "import matplotlib; import numpy; print('OK')"
        check_id = await real_session_manager.execute_cell_async(
            str(nb_path), 0, check_code
        )
    
        check_status = {"status": "not_found"}
        for _ in range(20):
            await asyncio.sleep(0.5)
            check_status = real_session_manager.get_execution_status(str(nb_path), check_id)
            if check_status["status"] in ["completed", "error"]:
                break
    
        if check_status["status"] == "error":
            pytest.skip("Matplotlib or numpy not available in test environment")
    
        # 4. Add a cell that creates a matplotlib plot and saves it
        plot_code = """
    import matplotlib.pyplot as plt
    import numpy as np
    
    x = np.linspace(0, 10, 100)
    y = np.sin(x)
    
    plt.figure(figsize=(8, 4))
    plt.plot(x, y)
    plt.title("Test Plot for Asset Extraction")
    plt.xlabel("X")
    plt.ylabel("Sin(X)")
    plt.grid(True)
    
    # Save the plot explicitly
    plt.savefig('test_plot.png')
    print("Plot saved as test_plot.png")
    
    # Also show it (should create display_data)
    plt.show()
    """
        notebook.insert_cell(str(nb_path), 0, plot_code)
    
        # 5. Execute the plot cell
        exec_id = await real_session_manager.execute_cell_async(str(nb_path), 0, plot_code)
        assert exec_id is not None
    
        # 6. Wait for execution to complete
        status = {"status": "not_found"}
        for _ in range(30):  # 15 seconds max
            await asyncio.sleep(0.5)
            status = real_session_manager.get_execution_status(str(nb_path), exec_id)
            if status["status"] in ["completed", "error"]:
                break
    
        # 7. Verify execution completed successfully
        assert status["status"] == "completed", f"Execution failed: {status}"
    
        # DEBUG: Print output to debug why png is missing
        print(f"DEBUG: Plot Execution Output:\n{status['output']}")
        print(f"DEBUG: Status dict: {status}")
        print(
            f"DEBUG: Intermediate outputs count: {status.get('intermediate_outputs_count', 0)}"
        )
    
        assets_dir = tmp_path / "assets"
        # Check if assets directory was created
        if assets_dir.exists():
            print(f"DEBUG: Assets dir exists with files: {list(assets_dir.glob('*'))}")
        else:
            print("DEBUG: Assets dir does not exist")
        assert assets_dir.exists(), "assets/ directory should be created"
    
        # 8. Check that PNG file was saved (either in assets/ or notebook directory)
        notebook_dir = tmp_path
        png_files = list(assets_dir.glob("*.png"))
        if not png_files:
            # Check in notebook directory for explicitly saved file
            png_files = list(notebook_dir.glob("*.png"))
    
>       assert (
            len(png_files) > 0
        ), f"At least one PNG file should be saved. Checked {assets_dir} and {notebook_dir}"
E       AssertionError: At least one PNG file should be saved. Checked /tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0/assets and /tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0
E       assert 0 > 0
E        +  where 0 = len([])

tests/test_real_world.py:131: AssertionError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:14:56 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:14:56 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:14:57 [info     ] [KERNEL] Assigning UUID: 5c9982cb-8ff2-4c15-a1af-766b6614a3c0
2026-01-25 18:14:57 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0/test_assets.ipynb cwd=/tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0 docker=False env=system
2026-01-25 18:14:59 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0/test_assets.ipynb
2026-01-25 18:14:59 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0/test_assets.ipynb
Waiting for status change on c4ee9933-9787ce2ef29ee4094fd244f5_15790_4 with timeout=300
2026-01-25 18:14:59 [debug    ] Buffering IOPub msg (type=status parent_id=c4ee9933-9787ce2ef29ee4094fd244f5_15790_2) - known exec keys: ['c4ee9933-9787ce2ef29ee4094fd244f5_15790_4'] (len=1)
2026-01-25 18:14:59 [debug    ] Buffering IOPub msg (type=stream parent_id=c4ee9933-9787ce2ef29ee4094fd244f5_15790_2) - known exec keys: ['c4ee9933-9787ce2ef29ee4094fd244f5_15790_4'] (len=1)
Finalizing c4ee9933-9787ce2ef29ee4094fd244f5_15790_4 status=completed cell_index=0
Waiting for status change on c4ee9933-9787ce2ef29ee4094fd244f5_15790_5 with timeout=300
DEBUG: Plot Execution Output:
[INTEGRITY WARNING] Cell 1 executed out-of-order; highest executed Cell 1. This may indicate hidden state has been relied upon.
DEBUG: Status dict: {'status': 'completed', 'output': '[INTEGRITY WARNING] Cell 1 executed out-of-order; highest executed Cell 1. This may indicate hidden state has been relied upon.', 'intermediate_outputs_count': 0}
DEBUG: Intermediate outputs count: 0
DEBUG: Assets dir exists with files: []
Finalizing c4ee9933-9787ce2ef29ee4094fd244f5_15790_5 status=completed cell_index=0
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 1244475f-ac12-46eb-8c2c-41f5ca5f9f27
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0/test_assets.ipynb (PID: 16737)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:15:02 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0/test_assets.ipynb
2026-01-25 18:15:02 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw1/test_end_to_end_asset_extracti0/test_assets.ipynb
______________________ test_inspect_variable_integration _______________________
[gw1] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-124/popen-gw1/test_inspect_variable_integrat0')
real_session_manager = <src.session.SessionManager object at 0x7aeffdb5eb10>

    @pytest.mark.asyncio
    @pytest.mark.optional
    async def test_inspect_variable_integration(tmp_path, real_session_manager):
        """
        Tests the inspect_variable tool with a real kernel.
    
        Validates:
        1. Variable inspection returns markdown-formatted output
        2. DataFrames show shape, columns, head
        3. Lists show length and sample
        4. Non-existent variables return error message
    
        Note: This test is marked as 'optional' because it requires pandas and numpy.
        Run with: pytest -m optional
        """
        # 1. Create notebook
        nb_path = tmp_path / "test_inspect.ipynb"
        notebook.create_notebook(str(nb_path))
    
        # 2. Start kernel
        await real_session_manager.start_kernel(str(nb_path))
    
        # 3. Create test variables
        setup_code = """
    import pandas as pd
    import numpy as np
    
    # Create test DataFrame
    df_test = pd.DataFrame({
        'A': [1, 2, 3, 4, 5],
        'B': ['a', 'b', 'c', 'd', 'e'],
        'C': [1.1, 2.2, 3.3, 4.4, 5.5]
    })
    
    # Create test list
    my_list = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    
    # Create test dict
    my_dict = {'key1': 'value1', 'key2': 'value2', 'key3': 'value3'}
    """
    
        exec_id = await real_session_manager.execute_cell_async(str(nb_path), 0, setup_code)
    
        # Wait for setup
        status = {"status": "not_found"}
        for _ in range(60):
            await asyncio.sleep(0.5)
            status = real_session_manager.get_execution_status(str(nb_path), exec_id)
            if status["status"] in ["completed", "error"]:
                break
    
        # Skip if pandas not available
        if status["status"] == "error":
            pytest.skip("Pandas or numpy not available in test environment")
    
        assert status["status"] == "completed", "Setup should complete successfully"
    
        # 4. Test DataFrame inspection via get_variable_info
        df_info = await real_session_manager.get_variable_info(str(nb_path), "df_test")
>       df_data = json.loads(df_info)

tests/test_real_world.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/__init__.py:346: in loads
    return _default_decoder.decode(s)
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:338: in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <json.decoder.JSONDecoder object at 0x7af00726d280>
s = '[INTEGRITY WARNING] Cell 0 executed out-of-order; highest executed Cell 1. This may indicate hidden state has been relied upon.'
idx = 0

    def raw_decode(self, s, idx=0):
        """Decode a JSON document from ``s`` (a ``str`` beginning with
        a JSON document) and return a 2-tuple of the Python
        representation and the index in ``s`` where the document ended.
    
        This can be used to decode a JSON document from a string that may
        have extraneous data at the end.
    
        """
        try:
            obj, end = self.scan_once(s, idx)
        except StopIteration as err:
>           raise JSONDecodeError("Expecting value", s, err.value) from None
E           json.decoder.JSONDecodeError: Expecting value: line 1 column 2 (char 1)

/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:356: JSONDecodeError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:15:02 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:15:02 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:15:02 [info     ] [KERNEL] Assigning UUID: 0688b170-178f-405a-bb41-dbca0c5f0514
2026-01-25 18:15:02 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-124/popen-gw1/test_inspect_variable_integrat0/test_inspect.ipynb cwd=/tmp/pytest-of-david/pytest-124/popen-gw1/test_inspect_variable_integrat0 docker=False env=system
2026-01-25 18:15:05 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-124/popen-gw1/test_inspect_variable_integrat0/test_inspect.ipynb
2026-01-25 18:15:05 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-124/popen-gw1/test_inspect_variable_integrat0/test_inspect.ipynb
Waiting for status change on 47134335-cdf6b9dadfb39bbd4254b59d_15790_4 with timeout=300
2026-01-25 18:15:05 [debug    ] Buffering IOPub msg (type=status parent_id=47134335-cdf6b9dadfb39bbd4254b59d_15790_2) - known exec keys: ['47134335-cdf6b9dadfb39bbd4254b59d_15790_4'] (len=1)
2026-01-25 18:15:05 [debug    ] Buffering IOPub msg (type=stream parent_id=47134335-cdf6b9dadfb39bbd4254b59d_15790_2) - known exec keys: ['47134335-cdf6b9dadfb39bbd4254b59d_15790_4'] (len=1)
Finalizing 47134335-cdf6b9dadfb39bbd4254b59d_15790_4 status=completed cell_index=0
Waiting for status change on 47134335-cdf6b9dadfb39bbd4254b59d_15790_5 with timeout=300
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 409473be-8b7d-42cf-b69a-0132e8efa72e
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw1/test_inspect_variable_integrat0/test_inspect.ipynb (PID: 17053)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:15:06 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw1/test_inspect_variable_integrat0/test_inspect.ipynb
Finalizing 47134335-cdf6b9dadfb39bbd4254b59d_15790_5 status=completed cell_index=-1
2026-01-25 18:15:06 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw1/test_inspect_variable_integrat0/test_inspect.ipynb
_______________________ test_get_variable_manifest_basic _______________________
[gw2] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

    @pytest.mark.asyncio
    async def test_get_variable_manifest_basic():
        """Test basic variable manifest retrieval"""
        session_manager = SessionManager()
    
        with tempfile.TemporaryDirectory() as tmpdir:
            nb_path = Path(tmpdir) / "test.ipynb"
    
            # Create minimal notebook
            nb = nbformat.v4.new_notebook()
            nb.cells.append(nbformat.v4.new_code_cell())
            with open(nb_path, "w") as f:
                nbformat.write(nb, f)
    
            # Start kernel
            await session_manager.start_kernel(str(nb_path))
    
            # Create some variables
            code = """
    x = 42
    name = "test"
    data = [1, 2, 3, 4, 5]
    mapping = {"a": 1, "b": 2, "c": 3}
    """
            await session_manager.run_simple_code(str(nb_path), code)
    
            # Get manifest
            manifest_json = await session_manager.run_simple_code(
                str(nb_path),
                """
    import json
    import sys
    
    def get_size_str(obj):
        try:
            size = sys.getsizeof(obj)
            if size < 1024:
                return f"{size} B"
            elif size < 1024 * 1024:
                return f"{size / 1024:.1f} KB"
            else:
                return f"{size / (1024 * 1024):.1f} MB"
        except:
            return "?"
    
    manifest = []
    for name in sorted(dir()):
        if not name.startswith('_'):
            try:
                obj = globals()[name]
                if not isinstance(obj, type(sys)):
                    manifest.append({
                        "name": name,
                        "type": type(obj).__name__,
                        "size": get_size_str(obj)
                    })
            except:
                pass
    
    print(json.dumps(manifest))
    """,
            )
    
            # Parse result
            result = json.loads(manifest_json)
>           manifest = json.loads(result["llm_summary"])

tests/test_variable_manifest.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/__init__.py:346: in loads
    return _default_decoder.decode(s)
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:338: in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <json.decoder.JSONDecoder object at 0x7b3d374e11f0>, s = '', idx = 0

    def raw_decode(self, s, idx=0):
        """Decode a JSON document from ``s`` (a ``str`` beginning with
        a JSON document) and return a 2-tuple of the Python
        representation and the index in ``s`` where the document ended.
    
        This can be used to decode a JSON document from a string that may
        have extraneous data at the end.
    
        """
        try:
            obj, end = self.scan_once(s, idx)
        except StopIteration as err:
>           raise JSONDecodeError("Expecting value", s, err.value) from None
E           json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)

/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:356: JSONDecodeError
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:15:03 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:15:03 [info     ] IOMultiplexer initialized (input_timeout=60s)
2026-01-25 18:15:03 [info     ] [KERNEL] Assigning UUID: 733d3ba7-100b-49f3-9e60-5374f3b99464
2026-01-25 18:15:03 [info     ] [KERNEL] Started /tmp/tmpq99l_toz/test.ipynb cwd=/tmp/tmpq99l_toz docker=False env=system
2026-01-25 18:15:06 [info     ] Starting IOPub listener for /tmp/tmpq99l_toz/test.ipynb
2026-01-25 18:15:06 [info     ] Starting stdin listener for /tmp/tmpq99l_toz/test.ipynb
Waiting for status change on 4eec0b87-637a6f7dbb6c429415df01a5_15793_4 with timeout=300
2026-01-25 18:15:06 [debug    ] Buffering IOPub msg (type=status parent_id=4eec0b87-637a6f7dbb6c429415df01a5_15793_2) - known exec keys: ['4eec0b87-637a6f7dbb6c429415df01a5_15793_4'] (len=1)
2026-01-25 18:15:06 [debug    ] Buffering IOPub msg (type=stream parent_id=4eec0b87-637a6f7dbb6c429415df01a5_15793_2) - known exec keys: ['4eec0b87-637a6f7dbb6c429415df01a5_15793_4'] (len=1)
Finalizing 4eec0b87-637a6f7dbb6c429415df01a5_15793_4 status=completed cell_index=-1
Waiting for status change on 4eec0b87-637a6f7dbb6c429415df01a5_15793_5 with timeout=300
Finalizing 4eec0b87-637a6f7dbb6c429415df01a5_15793_5 status=completed cell_index=-1
2026-01-25 18:15:07 [debug    ] Buffering IOPub msg (type=status parent_id=4eec0b87-637a6f7dbb6c429415df01a5_15793_2) - known exec keys: ['4eec0b87-637a6f7dbb6c429415df01a5_15793_4', '4eec0b87-637a6f7dbb6c429415df01a5_15793_5'] (len=2)
2026-01-25 18:15:07 [debug    ] Buffering IOPub msg (type=status parent_id=4eec0b87-637a6f7dbb6c429415df01a5_15793_3) - known exec keys: ['4eec0b87-637a6f7dbb6c429415df01a5_15793_4', '4eec0b87-637a6f7dbb6c429415df01a5_15793_5'] (len=2)
2026-01-25 18:15:07 [debug    ] Buffering IOPub msg (type=status parent_id=4eec0b87-637a6f7dbb6c429415df01a5_15793_3) - known exec keys: ['4eec0b87-637a6f7dbb6c429415df01a5_15793_4', '4eec0b87-637a6f7dbb6c429415df01a5_15793_5'] (len=2)
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: bf552992-0d2c-407d-acd9-3c309ed253fd
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/tmpq99l_toz/test.ipynb (PID: 17139)
INFO     src.observability:observability.py:16 Finalize exec 392d982d-1eb5-4dad-abea-9152187806ff text_summary len: 38
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/tmpq99l_toz/test.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/tmpq99l_toz/test.ipynb (PID: 17139)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:15:07 [info     ] IOPub listener cancelled for /tmp/tmpq99l_toz/test.ipynb
2026-01-25 18:15:07 [info     ] Stdin listener cancelled for /tmp/tmpq99l_toz/test.ipynb
_______________________ test_get_variable_manifest_empty _______________________
[gw9] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

    @pytest.mark.asyncio
    async def test_get_variable_manifest_empty():
        """Test manifest with no user variables"""
        session_manager = SessionManager()
    
        with tempfile.TemporaryDirectory() as tmpdir:
            nb_path = Path(tmpdir) / "test.ipynb"
    
            # Create minimal notebook
            nb = nbformat.v4.new_notebook()
            nb.cells.append(nbformat.v4.new_code_cell())
            with open(nb_path, "w") as f:
                nbformat.write(nb, f)
    
            # Start kernel
            await session_manager.start_kernel(str(nb_path))
    
            # Get manifest immediately (should be empty or minimal)
            manifest_json = await session_manager.run_simple_code(
                str(nb_path),
                """
    import json
    import sys
    
    manifest = []
    for name in sorted(dir()):
        if not name.startswith('_'):
            try:
                obj = globals()[name]
                if not isinstance(obj, type(sys)):
                    manifest.append({
                        "name": name,
                        "type": type(obj).__name__,
                        "size": "?"
                    })
            except:
                pass
    
    print(json.dumps(manifest))
    """,
            )
    
            # Parse result
            result = json.loads(manifest_json)
>           manifest = json.loads(result["llm_summary"])

tests/test_variable_manifest.py:259: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/__init__.py:346: in loads
    return _default_decoder.decode(s)
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:338: in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <json.decoder.JSONDecoder object at 0x722fe48a27b0>, s = '', idx = 0

    def raw_decode(self, s, idx=0):
        """Decode a JSON document from ``s`` (a ``str`` beginning with
        a JSON document) and return a 2-tuple of the Python
        representation and the index in ``s`` where the document ended.
    
        This can be used to decode a JSON document from a string that may
        have extraneous data at the end.
    
        """
        try:
            obj, end = self.scan_once(s, idx)
        except StopIteration as err:
>           raise JSONDecodeError("Expecting value", s, err.value) from None
E           json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)

/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:356: JSONDecodeError
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:15:04 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:15:04 [info     ] IOMultiplexer initialized (input_timeout=60s)
2026-01-25 18:15:04 [info     ] [KERNEL] Assigning UUID: e46aa51c-4737-4150-a437-5caad51ffc5a
2026-01-25 18:15:04 [info     ] [KERNEL] Started /tmp/tmp65q2cmxz/test.ipynb cwd=/tmp/tmp65q2cmxz docker=False env=system
2026-01-25 18:15:06 [info     ] Starting IOPub listener for /tmp/tmp65q2cmxz/test.ipynb
2026-01-25 18:15:06 [info     ] Starting stdin listener for /tmp/tmp65q2cmxz/test.ipynb
Waiting for status change on 2b0b7fcc-fda044eafb8933d5832581d5_15823_4 with timeout=300
2026-01-25 18:15:06 [debug    ] Buffering IOPub msg (type=status parent_id=2b0b7fcc-fda044eafb8933d5832581d5_15823_2) - known exec keys: ['2b0b7fcc-fda044eafb8933d5832581d5_15823_4'] (len=1)
2026-01-25 18:15:06 [debug    ] Buffering IOPub msg (type=stream parent_id=2b0b7fcc-fda044eafb8933d5832581d5_15823_2) - known exec keys: ['2b0b7fcc-fda044eafb8933d5832581d5_15823_4'] (len=1)
Finalizing 2b0b7fcc-fda044eafb8933d5832581d5_15823_4 status=completed cell_index=-1
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: b1563db8-d395-4293-bfa3-a181dab779e0
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/tmp65q2cmxz/test.ipynb (PID: 17209)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:15:08 [info     ] Stdin listener cancelled for /tmp/tmp65q2cmxz/test.ipynb
2026-01-25 18:15:08 [info     ] IOPub listener cancelled for /tmp/tmp65q2cmxz/test.ipynb
______________________ test_autoreload_enabled_on_startup ______________________
[gw0] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-124/popen-gw0/test_autoreload_enabled_on_sta0')
real_session_manager = <src.session.SessionManager object at 0x7814af31f5f0>

    @pytest.mark.asyncio
    async def test_autoreload_enabled_on_startup(tmp_path, real_session_manager):
        """
        Validates that autoreload is automatically enabled when kernel starts.
    
        This test verifies:
        1. Kernel can execute code after autoreload setup
        2. Autoreload doesn't break kernel functionality
        """
        # 1. Create notebook
        nb_path = tmp_path / "test_autoreload.ipynb"
        notebook.create_notebook(str(nb_path))
    
        # 2. Start kernel (autoreload should be injected)
        start_result = await real_session_manager.start_kernel(str(nb_path))
        assert "Kernel started" in start_result
    
        # 3. Verify kernel is functional after autoreload injection
        test_code = "x = 42\nprint(f'Value: {x}')"
        notebook.append_cell(str(nb_path), test_code)
    
        exec_id = await real_session_manager.execute_cell_async(str(nb_path), 0, test_code)
    
        status = {"status": "not_found"}
        for _ in range(40):  # Increased from 20 for parallel execution load
            await asyncio.sleep(0.5)
            status = real_session_manager.get_execution_status(str(nb_path), exec_id)
            if status["status"] in ["completed", "error"]:
                break
    
        assert (
            status["status"] == "completed"
        ), f"Kernel should be functional after autoreload. Got status: {status['status']}"
>       assert (
            "Value: 42" in status["output"]
        ), f"Kernel should execute code correctly. Got output: {status['output']}"
E       AssertionError: Kernel should execute code correctly. Got output: {"llm_summary": "", "raw_outputs": []}
E       assert 'Value: 42' in '{"llm_summary": "", "raw_outputs": []}'

tests/test_real_world.py:334: AssertionError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:15:05 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:15:05 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:15:05 [info     ] [KERNEL] Assigning UUID: 47522e10-46ba-47b7-b574-e6d4be5a1841
2026-01-25 18:15:05 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-124/popen-gw0/test_autoreload_enabled_on_sta0/test_autoreload.ipynb cwd=/tmp/pytest-of-david/pytest-124/popen-gw0/test_autoreload_enabled_on_sta0 docker=False env=system
2026-01-25 18:15:07 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-124/popen-gw0/test_autoreload_enabled_on_sta0/test_autoreload.ipynb
2026-01-25 18:15:07 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-124/popen-gw0/test_autoreload_enabled_on_sta0/test_autoreload.ipynb
Waiting for status change on adab54a1-6901483630ddb23a834573b2_15784_4 with timeout=300
2026-01-25 18:15:07 [debug    ] Buffering IOPub msg (type=status parent_id=adab54a1-6901483630ddb23a834573b2_15784_2) - known exec keys: ['adab54a1-6901483630ddb23a834573b2_15784_4'] (len=1)
2026-01-25 18:15:07 [debug    ] Buffering IOPub msg (type=stream parent_id=adab54a1-6901483630ddb23a834573b2_15784_2) - known exec keys: ['adab54a1-6901483630ddb23a834573b2_15784_4'] (len=1)
Finalizing adab54a1-6901483630ddb23a834573b2_15784_4 status=completed cell_index=0
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: fbebed4d-3cdc-4f97-aeb8-44ac2e29d5ed
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw0/test_autoreload_enabled_on_sta0/test_autoreload.ipynb (PID: 17270)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:15:09 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw0/test_autoreload_enabled_on_sta0/test_autoreload.ipynb
2026-01-25 18:15:09 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw0/test_autoreload_enabled_on_sta0/test_autoreload.ipynb
__________________ test_get_variable_manifest_with_large_data __________________
[gw2] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

    @pytest.mark.asyncio
    async def test_get_variable_manifest_with_large_data():
        """Test manifest with larger data structures"""
        session_manager = SessionManager()
    
        with tempfile.TemporaryDirectory() as tmpdir:
            nb_path = Path(tmpdir) / "test.ipynb"
    
            # Create minimal notebook
            nb = nbformat.v4.new_notebook()
            nb.cells.append(nbformat.v4.new_code_cell())
            with open(nb_path, "w") as f:
                nbformat.write(nb, f)
    
            # Start kernel
            await session_manager.start_kernel(str(nb_path))
    
            # Create large variables
            code = """
    large_list = list(range(10000))
    large_dict = {i: i**2 for i in range(1000)}
    text_data = "x" * 1000000  # 1MB string
    """
            await session_manager.run_simple_code(str(nb_path), code)
    
            # Get manifest
            manifest_json = await session_manager.run_simple_code(
                str(nb_path),
                """
    import json
    import sys
    
    def get_size_str(obj):
        try:
            size = sys.getsizeof(obj)
            if hasattr(obj, '__len__') and not isinstance(obj, (str, bytes)):
                try:
                    if isinstance(obj, (list, tuple, set)):
                        size += sum(sys.getsizeof(item) for item in list(obj)[:100])
                    elif isinstance(obj, dict):
                        items = list(obj.items())[:100]
                        size += sum(sys.getsizeof(k) + sys.getsizeof(v) for k, v in items)
                except:
                    pass
    
            if size < 1024:
                return f"{size} B"
            elif size < 1024 * 1024:
                return f"{size / 1024:.1f} KB"
            else:
                return f"{size / (1024 * 1024):.1f} MB"
        except:
            return "?"
    
    manifest = []
    for name in sorted(dir()):
        if not name.startswith('_'):
            try:
                obj = globals()[name]
                if not isinstance(obj, type(sys)):
                    manifest.append({
                        "name": name,
                        "type": type(obj).__name__,
                        "size": get_size_str(obj)
                    })
            except:
                pass
    
    print(json.dumps(manifest))
    """,
            )
    
            # Parse result
            result = json.loads(manifest_json)
>           manifest = json.loads(result["llm_summary"])

tests/test_variable_manifest.py:190: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/__init__.py:346: in loads
    return _default_decoder.decode(s)
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:338: in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <json.decoder.JSONDecoder object at 0x7b3d374e11f0>, s = '', idx = 0

    def raw_decode(self, s, idx=0):
        """Decode a JSON document from ``s`` (a ``str`` beginning with
        a JSON document) and return a 2-tuple of the Python
        representation and the index in ``s`` where the document ended.
    
        This can be used to decode a JSON document from a string that may
        have extraneous data at the end.
    
        """
        try:
            obj, end = self.scan_once(s, idx)
        except StopIteration as err:
>           raise JSONDecodeError("Expecting value", s, err.value) from None
E           json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)

/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:356: JSONDecodeError
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:15:07 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:15:07 [info     ] IOMultiplexer initialized (input_timeout=60s)
2026-01-25 18:15:07 [info     ] [KERNEL] Assigning UUID: fb6d9c87-c423-4ea9-aa83-2275d386c5e6
2026-01-25 18:15:07 [info     ] [KERNEL] Started /tmp/tmp_jpsoahw/test.ipynb cwd=/tmp/tmp_jpsoahw docker=False env=system
2026-01-25 18:15:10 [info     ] Starting IOPub listener for /tmp/tmp_jpsoahw/test.ipynb
2026-01-25 18:15:10 [info     ] Starting stdin listener for /tmp/tmp_jpsoahw/test.ipynb
Waiting for status change on 2299e8f6-0ec0c3096621ac1108f99e39_15793_4 with timeout=300
2026-01-25 18:15:10 [debug    ] Buffering IOPub msg (type=status parent_id=2299e8f6-0ec0c3096621ac1108f99e39_15793_2) - known exec keys: ['2299e8f6-0ec0c3096621ac1108f99e39_15793_4'] (len=1)
2026-01-25 18:15:10 [debug    ] Buffering IOPub msg (type=stream parent_id=2299e8f6-0ec0c3096621ac1108f99e39_15793_2) - known exec keys: ['2299e8f6-0ec0c3096621ac1108f99e39_15793_4'] (len=1)
Finalizing 2299e8f6-0ec0c3096621ac1108f99e39_15793_4 status=completed cell_index=-1
Waiting for status change on 2299e8f6-0ec0c3096621ac1108f99e39_15793_5 with timeout=300
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: b467ead8-c9e2-41c7-bf9b-92dc7197b202
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/tmp_jpsoahw/test.ipynb (PID: 17469)
ERROR    opentelemetry.exporter.otlp.proto.grpc.exporter:exporter.py:416 Failed to export traces to localhost:4317, error code: StatusCode.UNAVAILABLE
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:15:11 [info     ] Stdin listener cancelled for /tmp/tmp_jpsoahw/test.ipynb
2026-01-25 18:15:11 [info     ] IOPub listener cancelled for /tmp/tmp_jpsoahw/test.ipynb
Finalizing 2299e8f6-0ec0c3096621ac1108f99e39_15793_5 status=completed cell_index=-1
_______________________ test_variable_manifest_populates _______________________
[gw3] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0')

    @pytest.mark.asyncio
    @pytest.mark.integration
    async def test_variable_manifest_populates(tmp_path: Path):
        test_nb = tmp_path / "test_var_dashboard.ipynb"
        nb = nbformat.v4.new_notebook()
        nb.cells = [
            nbformat.v4.new_code_cell("x = 42"),
            nbformat.v4.new_code_cell("message = 'Hello World'"),
            nbformat.v4.new_code_cell("data = [1, 2, 3, 4, 5]"),
        ]
        nbformat.write(nb, test_nb)
    
        sm = SessionManager()
        try:
            await sm.start_kernel(str(test_nb))
            # Execute cells
            for i, cell in enumerate(nb.cells):
                task_id = await sm.execute_cell_async(str(test_nb), i, cell.source)
                # Wait for completion
                for _ in range(200):  # up to ~20s
                    status = sm.get_execution_status(str(test_nb), task_id)
                    if status.get("status") in {"completed", "error"}:
                        break
                    await asyncio.sleep(0.1)
    
            # Collect manifest (with retry for timing issues)
            manifest_code = _build_manifest_code()
            manifest = []
            for attempt in range(3):
                output = await sm.run_simple_code(str(test_nb), manifest_code)
                if output and not output.startswith("Error"):
                    try:
                        manifest = _extract_manifest_from_sanitized(output)
                        if manifest:  # Successfully extracted
                            break
                    except json.JSONDecodeError:
                        pass  # Retry
                await asyncio.sleep(0.5)
    
>           assert (
                manifest
            ), f"Failed to extract manifest after retries. Last output: {output!r}"
E           AssertionError: Failed to extract manifest after retries. Last output: '[INTEGRITY WARNING] Cell 0 executed out-of-order; highest executed Cell 3. This may indicate hidden state has been relied upon.{"llm_summary": "[{\\"name\\":\\"original_ps1\\",\\"type\\":\\"str\\",\\"size\\":\\"45 B\\"},{\\"name\\":\\"is_wsl\\",\\"type\\":\\"bool\\",\\"size\\":\\"28 B\\"},{\\"name\\":\\"x\\",\\"type\\":\\"int\\",\\"size\\":\\"28 B\\"},{\\"name\\":\\"message\\",\\"type\\":\\"str\\",\\"size\\":\\"52 B\\"},{\\"name\\":\\"data\\",\\"type\\":\\"list\\",\\"size\\":\\"104 B\\"}]\\n", "raw_outputs": [{"output_type": "stream", "metadata": {}, "name": "stdout", "text": "[{\\"name\\":\\"original_ps1\\",\\"type\\":\\"str\\",\\"size\\":\\"45 B\\"},{\\"name\\":\\"is_wsl\\",\\"type\\":\\"bool\\",\\"size\\":\\"28 B\\"},{\\"name\\":\\"x\\",\\"type\\":\\"int\\",\\"size\\":\\"28 B\\"},{\\"name\\":\\"message\\",\\"type\\":\\"str\\",\\"size\\":\\"52 B\\"},{\\"name\\":\\"data\\",\\"type\\":\\"list\\",\\"size\\":\\"104 B\\"}]\\n"}]}'
E           assert []

tests/test_variable_dashboard_integration.py:138: AssertionError
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:15:03 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:15:03 [info     ] IOMultiplexer initialized (input_timeout=60s)
2026-01-25 18:15:03 [info     ] [KERNEL] Assigning UUID: a218700e-2fd7-4309-ae7f-56996ac7a950
2026-01-25 18:15:04 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb cwd=/tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0 docker=False env=system
2026-01-25 18:15:07 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
2026-01-25 18:15:07 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
Waiting for status change on c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_5 with timeout=300
2026-01-25 18:15:07 [debug    ] Buffering IOPub msg (type=status parent_id=c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_3) - known exec keys: ['c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_5'] (len=1)
2026-01-25 18:15:07 [debug    ] Buffering IOPub msg (type=stream parent_id=c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_3) - known exec keys: ['c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_5'] (len=1)
Finalizing c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_5 status=completed cell_index=0
Waiting for status change on c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_6 with timeout=300
Finalizing c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_6 status=completed cell_index=1
Waiting for status change on c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_7 with timeout=300
Finalizing c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_7 status=completed cell_index=2
Waiting for status change on c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_8 with timeout=300
2026-01-25 18:15:08 [debug    ] Buffering IOPub msg (type=status parent_id=c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_3) - known exec keys: ['c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_5', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_6', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_7', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_8'] (len=4)
2026-01-25 18:15:08 [debug    ] Buffering IOPub msg (type=status parent_id=c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_4) - known exec keys: ['c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_5', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_6', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_7', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_8'] (len=4)
2026-01-25 18:15:08 [debug    ] Buffering IOPub msg (type=status parent_id=c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_4) - known exec keys: ['c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_5', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_6', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_7', 'c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_8'] (len=4)
Finalizing c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_8 status=completed cell_index=-1
Waiting for status change on c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_9 with timeout=300
Finalizing c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_9 status=completed cell_index=-1
Waiting for status change on c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_10 with timeout=300
Finalizing c6ec8b2a-f5e45a5669d3079f6a0f4a4a_15796_10 status=completed cell_index=-1
2026-01-25 18:15:11 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
2026-01-25 18:15:11 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
2026-01-25 18:15:12 [info     ] [KERNEL] Stopped /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 5fd8e930-70d3-4056-bd62-886f87d7b8ad
WARNING  opentelemetry.exporter.otlp.proto.grpc.exporter:exporter.py:424 Transient error StatusCode.UNAVAILABLE encountered while exporting traces to localhost:4317, retrying in 0.95s.
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 17205)
INFO     src.observability:observability.py:16 Finalize exec 93631bfb-5886-48b2-ab08-c70964664535 text_summary len: 38
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 17205)
INFO     src.observability:observability.py:16 Finalize exec 9e102829-cfa2-4f93-932f-172fbcba8b37 text_summary len: 38
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 17205)
INFO     src.observability:observability.py:16 Finalize exec 46509fe5-e91e-4bea-8515-bbab1ccef46c text_summary len: 38
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 17205)
INFO     src.observability:observability.py:16 Finalize exec 95d1f82f-15cb-43e4-816f-de9edae6bbcc text_summary len: 818
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 17205)
INFO     src.observability:observability.py:16 Finalize exec 30acc994-881d-4b11-a2fb-3e313658fd25 text_summary len: 818
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 17205)
INFO     src.observability:observability.py:16 Finalize exec 3b5c8cde-a1f8-414b-8a3d-b89247645467 text_summary len: 818
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw3/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 17205)
INFO     src.observability:observability.py:16 [ASSET CLEANUP] Prune result: Deleted 0 orphaned assets (0 bytes), kept 0 referenced assets
__________________________ test_multiple_asset_types ___________________________
[gw0] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-124/popen-gw0/test_multiple_asset_types0')
real_session_manager = <src.session.SessionManager object at 0x7814af351640>

    @pytest.mark.asyncio
    @pytest.mark.optional
    async def test_multiple_asset_types(tmp_path, real_session_manager):
        """
        Test that different asset types (PNG, SVG) are handled with priority.
    
        Priority: PDF > SVG > PNG > JPEG
        When multiple formats exist, only the highest priority should be saved.
    
        Note: This test is marked as 'optional' because it requires matplotlib.
        Run with: pytest -m optional
        """
        nb_path = tmp_path / "test_multi_assets.ipynb"
        notebook.create_notebook(str(nb_path))
    
        # Start kernel
        await real_session_manager.start_kernel(str(nb_path))
    
        # Create a cell that produces both PNG and SVG (SVG has higher priority)
        multi_format_code = """
    import matplotlib.pyplot as plt
    import numpy as np
    
    plt.rcParams['svg.fonttype'] = 'none'  # Enable SVG text
    
    fig, ax = plt.subplots()
    x = np.linspace(0, 2*np.pi, 100)
    ax.plot(x, np.sin(x))
    ax.set_title("Multi-format Test")
    
    # Display as both PNG and SVG
    from IPython.display import display, SVG
    display(fig)
    plt.close(fig)
    """
    
        notebook.append_cell(str(nb_path), multi_format_code)
    
        # Execute
        exec_id = await real_session_manager.execute_cell_async(
            str(nb_path), 0, multi_format_code
        )
    
        # Wait for completion
        status = {"status": "not_found"}
        for _ in range(60):
            await asyncio.sleep(0.5)
            status = real_session_manager.get_execution_status(str(nb_path), exec_id)
            if status["status"] in ["completed", "error"]:
                break
    
        # Skip if matplotlib not available
        if status["status"] == "error" and "matplotlib" in status.get("output", "").lower():
            pytest.skip("Matplotlib not available in test environment")
    
        assert status["status"] == "completed", f"Execution should complete: {status}"
    
        # Check assets directory
        assets_dir = tmp_path / "assets"
        if assets_dir.exists():
            asset_files = list(assets_dir.glob("asset_*"))
>           assert len(asset_files) > 0, "At least one asset should be saved"
E           AssertionError: At least one asset should be saved
E           assert 0 > 0
E            +  where 0 = len([])

tests/test_real_world.py:424: AssertionError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:15:09 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:15:09 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:15:09 [info     ] [KERNEL] Assigning UUID: 67195793-e711-46b3-8ae0-0190de68a529
2026-01-25 18:15:09 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-124/popen-gw0/test_multiple_asset_types0/test_multi_assets.ipynb cwd=/tmp/pytest-of-david/pytest-124/popen-gw0/test_multiple_asset_types0 docker=False env=system
2026-01-25 18:15:12 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-124/popen-gw0/test_multiple_asset_types0/test_multi_assets.ipynb
2026-01-25 18:15:12 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-124/popen-gw0/test_multiple_asset_types0/test_multi_assets.ipynb
Waiting for status change on 94eafa07-8c167647d48baefea5ce5a4b_15784_5 with timeout=300
2026-01-25 18:15:12 [debug    ] Buffering IOPub msg (type=status parent_id=94eafa07-8c167647d48baefea5ce5a4b_15784_3) - known exec keys: ['94eafa07-8c167647d48baefea5ce5a4b_15784_5'] (len=1)
2026-01-25 18:15:12 [debug    ] Buffering IOPub msg (type=stream parent_id=94eafa07-8c167647d48baefea5ce5a4b_15784_3) - known exec keys: ['94eafa07-8c167647d48baefea5ce5a4b_15784_5'] (len=1)
Finalizing 94eafa07-8c167647d48baefea5ce5a4b_15784_5 status=completed cell_index=0
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: e6816e1c-496c-43d4-9d4b-4974f7dffdfe
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw0/test_multiple_asset_types0/test_multi_assets.ipynb (PID: 17555)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:15:13 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw0/test_multiple_asset_types0/test_multi_assets.ipynb
2026-01-25 18:15:13 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw0/test_multiple_asset_types0/test_multi_assets.ipynb
_________________________ test_streaming_basic_output __________________________
[gw6] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0')

    @pytest.mark.asyncio
    async def test_streaming_basic_output(tmp_path):
        manager = SessionManager()
        nb_path = tmp_path / "test_streaming.ipynb"
        nb_path.write_text(
            """{
            "cells": [{"cell_type": "code", "source": "import time\nfor i in range(3):\n    print(f'Step {i}')\n    time.sleep(0.05)", "metadata": {}, "outputs": []}],
            "metadata": {"kernelspec": {"name": "python3", "display_name": "Python 3"}},
            "nbformat": 4,
            "nbformat_minor": 4
        }"""
        )
    
        await manager.start_kernel(str(nb_path))
    
        code = """
    import time
    for i in range(3):
        print(f'Step {i}')
        time.sleep(0.05)
    """
        exec_id = await manager.execute_cell_async(str(nb_path), 0, code)
    
        # Poll for outputs
        for _ in range(200):
            await asyncio.sleep(0.05)
            session = manager.get_session(str(nb_path))
            if session:
                for _, data in session["executions"].items():
                    if data.get("id") == exec_id and data.get("status") in [
                        "completed",
                        "error",
                    ]:
                        await manager.stop_kernel(str(nb_path))
                        return
    
        await manager.stop_kernel(str(nb_path))
>       assert False, "Execution did not complete in time"
E       AssertionError: Execution did not complete in time
E       assert False

tests/test_streaming_features.py:47: AssertionError
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:14:59 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:14:59 [info     ] IOMultiplexer initialized (input_timeout=60s)
2026-01-25 18:14:59 [info     ] [KERNEL] Assigning UUID: 9adbc000-e9bd-43b7-84b1-ae4a71db8894
2026-01-25 18:14:59 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb cwd=/tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0 docker=False env=system
2026-01-25 18:15:03 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb
2026-01-25 18:15:03 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb
Waiting for status change on caa018de-224000a4a7e5a6a06b401d89_15810_5 with timeout=300
2026-01-25 18:15:03 [debug    ] Buffering IOPub msg (type=status parent_id=caa018de-224000a4a7e5a6a06b401d89_15810_3) - known exec keys: ['caa018de-224000a4a7e5a6a06b401d89_15810_5'] (len=1)
2026-01-25 18:15:03 [debug    ] Buffering IOPub msg (type=stream parent_id=caa018de-224000a4a7e5a6a06b401d89_15810_3) - known exec keys: ['caa018de-224000a4a7e5a6a06b401d89_15810_5'] (len=1)
2026-01-25 18:15:05 [debug    ] Buffering IOPub msg (type=status parent_id=caa018de-224000a4a7e5a6a06b401d89_15810_3) - known exec keys: ['caa018de-224000a4a7e5a6a06b401d89_15810_5'] (len=1)
2026-01-25 18:15:05 [debug    ] Buffering IOPub msg (type=status parent_id=caa018de-224000a4a7e5a6a06b401d89_15810_4) - known exec keys: ['caa018de-224000a4a7e5a6a06b401d89_15810_5'] (len=1)
2026-01-25 18:15:05 [debug    ] Buffering IOPub msg (type=status parent_id=caa018de-224000a4a7e5a6a06b401d89_15810_4) - known exec keys: ['caa018de-224000a4a7e5a6a06b401d89_15810_5'] (len=1)
Finalizing caa018de-224000a4a7e5a6a06b401d89_15810_5 status=completed cell_index=0
2026-01-25 18:15:13 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb
2026-01-25 18:15:13 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb
2026-01-25 18:15:14 [info     ] [KERNEL] Stopped /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: fe103d8b-396d-49ae-980b-fa791314509a
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb (PID: 16916)
INFO     src.observability:observability.py:16 Finalize exec eb5e836c-2996-41ca-ac50-4b9f89235331 text_summary len: 157
WARNING  src.observability:observability.py:16 Could not compute hash: Notebook does not appear to be JSON: '{\n        "cells": [{"cell_type": "cod...
ERROR    src.observability:observability.py:16 Failed to finalize execution: Notebook does not appear to be JSON: '{\n        "cells": [{"cell_type": "cod...
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-124/popen-gw6/test_streaming_basic_output0/test_streaming.ipynb (PID: 16916)
INFO     src.observability:observability.py:16 [ASSET CLEANUP] Prune result: Deleted 0 orphaned assets (0 bytes), kept 0 referenced assets
___________________ test_websocket_connection_and_execution ____________________
[gw9] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-124/popen-gw9/test_websocket_connection_and_1')

    @pytest.mark.asyncio
    async def test_websocket_connection_and_execution(tmp_path):
        package_root = str(Path(__file__).parent.parent)
        harness = MCPWebSocketHarness(cwd=package_root)
    
        try:
>           await harness.start()

tests/test_websocket_transport.py:269: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/test_websocket_transport.py:96: in start
    raise e
tests/test_websocket_transport.py:72: in start
    await self._wait_for_port(10.0)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <tests.test_websocket_transport.MCPWebSocketHarness object at 0x722fd84fed80>
timeout = 10.0

    async def _wait_for_port(self, timeout):
        """Wait for the server port to be ready by polling socket connectivity."""
        start_time = asyncio.get_event_loop().time()
        last_error = None
    
        # Simple, reliable approach: just poll the socket
        while True:
            try:
                # Try to connect to the server
                with socket.create_connection(("127.0.0.1", self.port), timeout=0.5):
                    logger.info(f"Successfully connected to port {self.port}")
                    return
            except (ConnectionRefusedError, OSError, socket.timeout) as e:
                last_error = e
    
            # Check timeout
            elapsed = asyncio.get_event_loop().time() - start_time
            if elapsed > timeout:
                # Log any available output for debugging
                await self._drain_output_for_debug()
>               raise TimeoutError(
                    f"Port {self.port} did not open within {timeout}s (last error: {last_error})"
                )
E               TimeoutError: Port 54917 did not open within 10.0s (last error: [Errno 111] Connection refused)

tests/test_websocket_transport.py:118: TimeoutError
----------------------------- Captured stdout call -----------------------------
[WS HARNESS] launching server
[WS HARNESS] server process started
[WS HARNESS] waiting for port
------------------------------ Captured log call -------------------------------
INFO     tests.test_websocket_transport:test_websocket_transport.py:51 Starting server with command: /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python -u -m src.main --transport websocket --port 54917
ERROR    tests.test_websocket_transport:test_websocket_transport.py:140 Server stdout: 2026-01-25 18:15:12 [warning  ]   Kubernetes config not available, using local mode
ERROR    tests.test_websocket_transport:test_websocket_transport.py:140 Server stderr: {"asctime": "2026-01-25 18:15:11,636", "name": "src.k8s_manager", "levelname": "WARNING", "message": "Kubernetes configuration not found or invalid; operating without Kubernetes: Invalid kube-config file. No configuration found.", "module": "k8s_manager", "funcName": "__init__", "taskName": null}
ERROR    tests.test_websocket_transport:test_websocket_transport.py:140 Server stderr: INFO:     Started server process [17503]
ERROR    tests.test_websocket_transport:test_websocket_transport.py:140 Server stderr: INFO:     Waiting for application startup.
ERROR    tests.test_websocket_transport:test_websocket_transport.py:140 Server stderr: INFO:     Application startup complete.
ERROR    tests.test_websocket_transport:test_websocket_transport.py:140 Server stderr: INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
=============================== warnings summary ===============================
src/config.py:13: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/src/config.py:13: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    PORT: int = Field(8000, ge=1024, le=65535, env="MCP_PORT")

src/config.py:14: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/src/config.py:14: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    LOG_LEVEL: Literal["debug", "info", "warning", "error", "critical"] = Field(

tests/test_e2e.py:8: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/tests/test_e2e.py:8: PytestUnknownMarkWarning: Unknown pytest.mark.e2e - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.e2e

tests/test_variable_dashboard_integration.py:100: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/tests/test_variable_dashboard_integration.py:100: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

tests/test_variable_dashboard_integration.py:150: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/tests/test_variable_dashboard_integration.py:150: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

tests/test_git_awareness.py::TestCellIDOperations::test_edit_cell_heals_missing_id_using_expected_index
tests/test_git_awareness.py::TestCellIDOperations::test_delete_cell_heals_missing_id_using_expected_index
  /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/lib/python3.12/site-packages/nbformat/__init__.py:132: MissingIDFieldWarning: Cell is missing an id field, this will become a hard error in future nbformat versions. You may want to use `normalize()` on your notebooks before validations (available since nbformat 5.1.4). Previous versions of nbformat are fixing this issue transparently, and will stop doing so in the future.
    validate(nb)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_security_fixes.py::TestSmallHTMLTablePreview::test_convert_pandas_style_table
FAILED tests/test_comprehensive_async.py::test_cwd_is_notebook_dir - assert '...
FAILED tests/test_security_fixes.py::TestHTMLTableIntegration::test_small_dataframe_shows_inline
FAILED tests/test_real_world.py::test_end_to_end_asset_extraction_and_provenance
FAILED tests/test_real_world.py::test_inspect_variable_integration - json.dec...
FAILED tests/test_variable_manifest.py::test_get_variable_manifest_basic - js...
FAILED tests/test_variable_manifest.py::test_get_variable_manifest_empty - js...
FAILED tests/test_real_world.py::test_autoreload_enabled_on_startup - Asserti...
FAILED tests/test_variable_manifest.py::test_get_variable_manifest_with_large_data
FAILED tests/test_variable_dashboard_integration.py::test_variable_manifest_populates
FAILED tests/test_real_world.py::test_multiple_asset_types - AssertionError: ...
FAILED tests/test_streaming_features.py::test_streaming_basic_output - Assert...
FAILED tests/test_websocket_transport.py::test_websocket_connection_and_execution
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 13 failures !!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!! xdist.dsession.Interrupted: stopping after 5 failures !!!!!!!!!!!!!
13 failed, 616 passed, 7 skipped, 52 warnings in 83.74s (0:01:23)
