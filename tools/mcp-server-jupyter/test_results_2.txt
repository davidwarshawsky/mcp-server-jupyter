bringing up nodes...
bringing up nodes...

...................................................s.................... [ 11%]
......................................................................... [ 22%]
........................................................................ [ 34%]
......................................................................s. [ 45%]
........................................................................ [ 56%]
............................s........................................... [ 68%]
.....F.............................F.............F.....F.....s..s....... [ 79%]
........................................................................ [ 90%]
...........F....s.........F..........sFailed to export traces to localhost:4317, error code: StatusCode.DEADLINE_EXCEEDED
...Transient error StatusCode.UNAVAILABLE encountered while exporting traces to localhost:4317, retrying in 1.15s.
......Failed to export traces to localhost:4317, error code: StatusCode.UNAVAILABLE
Transient error StatusCode.UNAVAILABLE encountered while exporting metrics to localhost:4317, retrying in 1.19s.
Failed to export metrics to localhost:4317, error code: StatusCode.UNAVAILABLE
........Transient error StatusCode.UNAVAILABLE encountered while exporting metrics to localhost:4317, retrying in 0.97s.
Failed to export metrics to localhost:4317, error code: StatusCode.DEADLINE_EXCEEDED

=================================== FAILURES ===================================
___________________________ test_cwd_is_notebook_dir ___________________________
[gw7] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

session_manager_fixture = <src.session.SessionManager object at 0x7f109f100800>
temp_notebook = '/tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb'

    @pytest.mark.asyncio
    async def test_cwd_is_notebook_dir(session_manager_fixture, temp_notebook):
        manager = session_manager_fixture
        await manager.start_kernel(temp_notebook)
    
        # code to check cwd
        code = "import os; print(os.getcwd())"
        exec_id = await manager.execute_cell_async(temp_notebook, 0, code)
    
        final_status = None
        for _ in range(60):  # Increased to account for parallel execution load
            await asyncio.sleep(0.5)
            status = manager.get_execution_status(temp_notebook, exec_id)
            if status["status"] == "completed":
                final_status = status
                break
    
        assert final_status is not None
        # We expect the CWD to be the directory of possible notebook
        expected_dir = str(Path(temp_notebook).parent.resolve())
        # Normalize slashes for comparison
        output_clean = final_status["output"].strip().replace("\\", "/")
        expected_clean = expected_dir.replace("\\", "/")
    
        # The output might print it somewhat differently (case sensitivity on Windows), but let's check basic containment
>       assert expected_clean.lower() in output_clean.lower()
E       assert '/tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks' in '{"llm_summary": "", "raw_outputs": []}'
E        +  where '/tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks' = <built-in method lower of str object at 0x7f109f170fb0>()
E        +    where <built-in method lower of str object at 0x7f109f170fb0> = '/tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks'.lower
E        +  and   '{"llm_summary": "", "raw_outputs": []}' = <built-in method lower of str object at 0x7f109f150c30>()
E        +    where <built-in method lower of str object at 0x7f109f150c30> = '{"llm_summary": "", "raw_outputs": []}'.lower

tests/test_comprehensive_async.py:137: AssertionError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:19:51 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:19:51 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:19:51 [info     ] [KERNEL] Assigning UUID: 9e345156-32d4-400e-9923-9254fc1c340c
2026-01-25 18:19:51 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb cwd=/tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks docker=False env=system
2026-01-25 18:19:52 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb
2026-01-25 18:19:52 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb
Waiting for status change on f5ddade8-3c3e1cd2e07d2ec4200f7b9e_20198_3 with timeout=300
2026-01-25 18:19:52 [debug    ] Buffering IOPub msg (type=status parent_id=f5ddade8-3c3e1cd2e07d2ec4200f7b9e_20198_1) - known exec keys: ['f5ddade8-3c3e1cd2e07d2ec4200f7b9e_20198_3'] (len=1)
2026-01-25 18:19:52 [debug    ] Buffering IOPub msg (type=stream parent_id=f5ddade8-3c3e1cd2e07d2ec4200f7b9e_20198_1) - known exec keys: ['f5ddade8-3c3e1cd2e07d2ec4200f7b9e_20198_3'] (len=1)
Finalizing f5ddade8-3c3e1cd2e07d2ec4200f7b9e_20198_3 status=completed cell_index=0
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 23a5816d-488c-4ac7-ac37-c8c1c299e627
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb (PID: 20953)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:19:54 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb
2026-01-25 18:19:54 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw7/test_cwd_is_notebook_dir0/notebooks/async_test.ipynb
______________________ test_inspect_variable_integration _______________________
[gw2] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-126/popen-gw2/test_inspect_variable_integrat0')
real_session_manager = <src.session.SessionManager object at 0x762318104fe0>

    @pytest.mark.asyncio
    @pytest.mark.optional
    async def test_inspect_variable_integration(tmp_path, real_session_manager):
        """
        Tests the inspect_variable tool with a real kernel.
    
        Validates:
        1. Variable inspection returns markdown-formatted output
        2. DataFrames show shape, columns, head
        3. Lists show length and sample
        4. Non-existent variables return error message
    
        Note: This test is marked as 'optional' because it requires pandas and numpy.
        Run with: pytest -m optional
        """
        # 1. Create notebook
        nb_path = tmp_path / "test_inspect.ipynb"
        notebook.create_notebook(str(nb_path))
    
        # 2. Start kernel
        await real_session_manager.start_kernel(str(nb_path))
    
        # 3. Create test variables
        setup_code = """
    import pandas as pd
    import numpy as np
    
    # Create test DataFrame
    df_test = pd.DataFrame({
        'A': [1, 2, 3, 4, 5],
        'B': ['a', 'b', 'c', 'd', 'e'],
        'C': [1.1, 2.2, 3.3, 4.4, 5.5]
    })
    
    # Create test list
    my_list = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    
    # Create test dict
    my_dict = {'key1': 'value1', 'key2': 'value2', 'key3': 'value3'}
    """
    
        exec_id = await real_session_manager.execute_cell_async(str(nb_path), 0, setup_code)
    
        # Wait for setup
        status = {"status": "not_found"}
        for _ in range(60):
            await asyncio.sleep(0.5)
            status = real_session_manager.get_execution_status(str(nb_path), exec_id)
            if status["status"] in ["completed", "error"]:
                break
    
        # Skip if pandas not available
        if status["status"] == "error":
            pytest.skip("Pandas or numpy not available in test environment")
    
        assert status["status"] == "completed", "Setup should complete successfully"
    
        # 4. Test DataFrame inspection via get_variable_info
        df_info = await real_session_manager.get_variable_info(str(nb_path), "df_test")
>       df_data = json.loads(df_info)

tests/test_real_world.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/__init__.py:346: in loads
    return _default_decoder.decode(s)
/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:338: in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <json.decoder.JSONDecoder object at 0x762323954f50>
s = '[INTEGRITY WARNING] Cell 0 executed out-of-order; highest executed Cell 1. This may indicate hidden state has been relied upon.'
idx = 0

    def raw_decode(self, s, idx=0):
        """Decode a JSON document from ``s`` (a ``str`` beginning with
        a JSON document) and return a 2-tuple of the Python
        representation and the index in ``s`` where the document ended.
    
        This can be used to decode a JSON document from a string that may
        have extraneous data at the end.
    
        """
        try:
            obj, end = self.scan_once(s, idx)
        except StopIteration as err:
>           raise JSONDecodeError("Expecting value", s, err.value) from None
E           json.decoder.JSONDecodeError: Expecting value: line 1 column 2 (char 1)

/home/david/.pyenv/versions/3.12.10/lib/python3.12/json/decoder.py:356: JSONDecodeError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:19:52 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:19:52 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:19:52 [info     ] [KERNEL] Assigning UUID: 20eb1eca-1e63-46e7-826d-c5828b327840
2026-01-25 18:19:52 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-126/popen-gw2/test_inspect_variable_integrat0/test_inspect.ipynb cwd=/tmp/pytest-of-david/pytest-126/popen-gw2/test_inspect_variable_integrat0 docker=False env=system
2026-01-25 18:19:54 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-126/popen-gw2/test_inspect_variable_integrat0/test_inspect.ipynb
2026-01-25 18:19:54 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-126/popen-gw2/test_inspect_variable_integrat0/test_inspect.ipynb
Waiting for status change on 1704fa2f-ffbe56c251e16aaf908440c8_20183_4 with timeout=300
2026-01-25 18:19:54 [debug    ] Buffering IOPub msg (type=status parent_id=1704fa2f-ffbe56c251e16aaf908440c8_20183_2) - known exec keys: ['1704fa2f-ffbe56c251e16aaf908440c8_20183_4'] (len=1)
2026-01-25 18:19:54 [debug    ] Buffering IOPub msg (type=stream parent_id=1704fa2f-ffbe56c251e16aaf908440c8_20183_2) - known exec keys: ['1704fa2f-ffbe56c251e16aaf908440c8_20183_4'] (len=1)
Finalizing 1704fa2f-ffbe56c251e16aaf908440c8_20183_4 status=completed cell_index=0
Waiting for status change on 1704fa2f-ffbe56c251e16aaf908440c8_20183_5 with timeout=300
2026-01-25 18:19:55 [debug    ] Buffering IOPub msg (type=status parent_id=1704fa2f-ffbe56c251e16aaf908440c8_20183_2) - known exec keys: ['1704fa2f-ffbe56c251e16aaf908440c8_20183_4', '1704fa2f-ffbe56c251e16aaf908440c8_20183_5'] (len=2)
2026-01-25 18:19:55 [debug    ] Buffering IOPub msg (type=status parent_id=1704fa2f-ffbe56c251e16aaf908440c8_20183_3) - known exec keys: ['1704fa2f-ffbe56c251e16aaf908440c8_20183_4', '1704fa2f-ffbe56c251e16aaf908440c8_20183_5'] (len=2)
2026-01-25 18:19:55 [debug    ] Buffering IOPub msg (type=status parent_id=1704fa2f-ffbe56c251e16aaf908440c8_20183_3) - known exec keys: ['1704fa2f-ffbe56c251e16aaf908440c8_20183_4', '1704fa2f-ffbe56c251e16aaf908440c8_20183_5'] (len=2)
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 7027a9ac-be4a-4759-8dda-b05ebaaf925d
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw2/test_inspect_variable_integrat0/test_inspect.ipynb (PID: 21053)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:19:56 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw2/test_inspect_variable_integrat0/test_inspect.ipynb
Finalizing 1704fa2f-ffbe56c251e16aaf908440c8_20183_5 status=completed cell_index=-1
2026-01-25 18:19:56 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw2/test_inspect_variable_integrat0/test_inspect.ipynb
__________ TestHTMLTableIntegration.test_small_dataframe_shows_inline __________
[gw1] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

self = <tests.test_security_fixes.TestHTMLTableIntegration object at 0x7d1e52eea090>
tmp_path = PosixPath('/tmp/pytest-of-david/pytest-126/popen-gw1/test_small_dataframe_shows_inl0')

        @pytest.mark.asyncio
        async def test_small_dataframe_shows_inline(self, tmp_path):
            """Small DataFrames should display as markdown tables."""
            pytest.importorskip("pandas")
    
            manager = SessionManager()
            nb_path = tmp_path / "test_table.ipynb"
    
            # Create notebook
            nb = nbformat.v4.new_notebook()
            nb.cells.append(nbformat.v4.new_code_cell("import pandas as pd"))
            with open(nb_path, "w") as f:
                nbformat.write(nb, f)
    
            try:
                await manager.start_kernel(str(nb_path))
    
                # Create small DataFrame
                code = """
    import pandas as pd
    df = pd.DataFrame({'A': [1, 2, 3], 'B': [4, 5, 6]})
    df.head()
    """
                result = await manager.run_simple_code(str(nb_path), code)
    
                # Should contain markdown table (Data Preview) if HTML conversion worked
                # OR fallback message if conversion failed
>               assert "[Data Preview]" in result or "[HTML Table detected" in result
E               assert ('[Data Preview]' in '{"llm_summary": "", "raw_outputs": []}' or '[HTML Table detected' in '{"llm_summary": "", "raw_outputs": []}')

tests/test_security_fixes.py:194: AssertionError
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:19:55 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:19:55 [info     ] IOMultiplexer initialized (input_timeout=60s)
2026-01-25 18:19:55 [info     ] [KERNEL] Assigning UUID: 360762be-1f2e-4db0-b348-f3ace7ebada9
2026-01-25 18:19:55 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-126/popen-gw1/test_small_dataframe_shows_inl0/test_table.ipynb cwd=/tmp/pytest-of-david/pytest-126/popen-gw1/test_small_dataframe_shows_inl0 docker=False env=system
2026-01-25 18:19:57 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-126/popen-gw1/test_small_dataframe_shows_inl0/test_table.ipynb
2026-01-25 18:19:57 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-126/popen-gw1/test_small_dataframe_shows_inl0/test_table.ipynb
Waiting for status change on 7ab8ff6e-87cbbc174aca80cead014709_20180_4 with timeout=300
2026-01-25 18:19:57 [debug    ] Buffering IOPub msg (type=status parent_id=7ab8ff6e-87cbbc174aca80cead014709_20180_2) - known exec keys: ['7ab8ff6e-87cbbc174aca80cead014709_20180_4'] (len=1)
2026-01-25 18:19:57 [debug    ] Buffering IOPub msg (type=stream parent_id=7ab8ff6e-87cbbc174aca80cead014709_20180_2) - known exec keys: ['7ab8ff6e-87cbbc174aca80cead014709_20180_4'] (len=1)
2026-01-25 18:19:58 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw1/test_small_dataframe_shows_inl0/test_table.ipynb
Finalizing 7ab8ff6e-87cbbc174aca80cead014709_20180_4 status=completed cell_index=-1
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 9927b71f-8a10-4bf9-ad0b-6444bf1a95e7
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw1/test_small_dataframe_shows_inl0/test_table.ipynb (PID: 21251)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:19:58 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw1/test_small_dataframe_shows_inl0/test_table.ipynb
______________________ test_autoreload_enabled_on_startup ______________________
[gw2] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-126/popen-gw2/test_autoreload_enabled_on_sta0')
real_session_manager = <src.session.SessionManager object at 0x7623180e8650>

    @pytest.mark.asyncio
    async def test_autoreload_enabled_on_startup(tmp_path, real_session_manager):
        """
        Validates that autoreload is automatically enabled when kernel starts.
    
        This test verifies:
        1. Kernel can execute code after autoreload setup
        2. Autoreload doesn't break kernel functionality
        """
        # 1. Create notebook
        nb_path = tmp_path / "test_autoreload.ipynb"
        notebook.create_notebook(str(nb_path))
    
        # 2. Start kernel (autoreload should be injected)
        start_result = await real_session_manager.start_kernel(str(nb_path))
        assert "Kernel started" in start_result
    
        # 3. Verify kernel is functional after autoreload injection
        test_code = "x = 42\nprint(f'Value: {x}')"
        notebook.append_cell(str(nb_path), test_code)
    
        exec_id = await real_session_manager.execute_cell_async(str(nb_path), 0, test_code)
    
        status = {"status": "not_found"}
        for _ in range(40):  # Increased from 20 for parallel execution load
            await asyncio.sleep(0.5)
            status = real_session_manager.get_execution_status(str(nb_path), exec_id)
            if status["status"] in ["completed", "error"]:
                break
    
        assert (
            status["status"] == "completed"
        ), f"Kernel should be functional after autoreload. Got status: {status['status']}"
>       assert (
            "Value: 42" in status["output"]
        ), f"Kernel should execute code correctly. Got output: {status['output']}"
E       AssertionError: Kernel should execute code correctly. Got output: {"llm_summary": "", "raw_outputs": []}
E       assert 'Value: 42' in '{"llm_summary": "", "raw_outputs": []}'

tests/test_real_world.py:334: AssertionError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:19:56 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:19:56 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:19:56 [info     ] [KERNEL] Assigning UUID: 479c7789-5648-4ea4-9001-a015ca198e9d
2026-01-25 18:19:56 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-126/popen-gw2/test_autoreload_enabled_on_sta0/test_autoreload.ipynb cwd=/tmp/pytest-of-david/pytest-126/popen-gw2/test_autoreload_enabled_on_sta0 docker=False env=system
2026-01-25 18:19:58 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-126/popen-gw2/test_autoreload_enabled_on_sta0/test_autoreload.ipynb
2026-01-25 18:19:58 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-126/popen-gw2/test_autoreload_enabled_on_sta0/test_autoreload.ipynb
Waiting for status change on faf23703-27d4afa843a7b52e4cd21b7e_20183_3 with timeout=300
2026-01-25 18:19:58 [debug    ] Buffering IOPub msg (type=status parent_id=faf23703-27d4afa843a7b52e4cd21b7e_20183_1) - known exec keys: ['faf23703-27d4afa843a7b52e4cd21b7e_20183_3'] (len=1)
2026-01-25 18:19:58 [debug    ] Buffering IOPub msg (type=stream parent_id=faf23703-27d4afa843a7b52e4cd21b7e_20183_1) - known exec keys: ['faf23703-27d4afa843a7b52e4cd21b7e_20183_3'] (len=1)
Finalizing faf23703-27d4afa843a7b52e4cd21b7e_20183_3 status=completed cell_index=0
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: e67543a3-448f-4cf3-b8f6-fb4c5003129d
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw2/test_autoreload_enabled_on_sta0/test_autoreload.ipynb (PID: 21278)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:19:59 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw2/test_autoreload_enabled_on_sta0/test_autoreload.ipynb
2026-01-25 18:19:59 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw2/test_autoreload_enabled_on_sta0/test_autoreload.ipynb
__________________________ test_multiple_asset_types ___________________________
[gw2] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-126/popen-gw2/test_multiple_asset_types0')
real_session_manager = <src.session.SessionManager object at 0x762312fbaff0>

    @pytest.mark.asyncio
    @pytest.mark.optional
    async def test_multiple_asset_types(tmp_path, real_session_manager):
        """
        Test that different asset types (PNG, SVG) are handled with priority.
    
        Priority: PDF > SVG > PNG > JPEG
        When multiple formats exist, only the highest priority should be saved.
    
        Note: This test is marked as 'optional' because it requires matplotlib.
        Run with: pytest -m optional
        """
        nb_path = tmp_path / "test_multi_assets.ipynb"
        notebook.create_notebook(str(nb_path))
    
        # Start kernel
        await real_session_manager.start_kernel(str(nb_path))
    
        # Create a cell that produces both PNG and SVG (SVG has higher priority)
        multi_format_code = """
    import matplotlib.pyplot as plt
    import numpy as np
    
    plt.rcParams['svg.fonttype'] = 'none'  # Enable SVG text
    
    fig, ax = plt.subplots()
    x = np.linspace(0, 2*np.pi, 100)
    ax.plot(x, np.sin(x))
    ax.set_title("Multi-format Test")
    
    # Display as both PNG and SVG
    from IPython.display import display, SVG
    display(fig)
    plt.close(fig)
    """
    
        notebook.append_cell(str(nb_path), multi_format_code)
    
        # Execute
        exec_id = await real_session_manager.execute_cell_async(
            str(nb_path), 0, multi_format_code
        )
    
        # Wait for completion
        status = {"status": "not_found"}
        for _ in range(60):
            await asyncio.sleep(0.5)
            status = real_session_manager.get_execution_status(str(nb_path), exec_id)
            if status["status"] in ["completed", "error"]:
                break
    
        # Skip if matplotlib not available
        if status["status"] == "error" and "matplotlib" in status.get("output", "").lower():
            pytest.skip("Matplotlib not available in test environment")
    
        assert status["status"] == "completed", f"Execution should complete: {status}"
    
        # Check assets directory
        assets_dir = tmp_path / "assets"
        if assets_dir.exists():
            asset_files = list(assets_dir.glob("asset_*"))
>           assert len(asset_files) > 0, "At least one asset should be saved"
E           AssertionError: At least one asset should be saved
E           assert 0 > 0
E            +  where 0 = len([])

tests/test_real_world.py:424: AssertionError
---------------------------- Captured stdout setup -----------------------------
2026-01-25 18:19:59 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:19:59 [info     ] IOMultiplexer initialized (input_timeout=60s)
------------------------------ Captured log setup ------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:19:59 [info     ] [KERNEL] Assigning UUID: a769dddb-764d-4fd5-acde-b09c0accb30a
2026-01-25 18:19:59 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-126/popen-gw2/test_multiple_asset_types0/test_multi_assets.ipynb cwd=/tmp/pytest-of-david/pytest-126/popen-gw2/test_multiple_asset_types0 docker=False env=system
2026-01-25 18:20:02 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-126/popen-gw2/test_multiple_asset_types0/test_multi_assets.ipynb
2026-01-25 18:20:02 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-126/popen-gw2/test_multiple_asset_types0/test_multi_assets.ipynb
Waiting for status change on 369895d3-a9bd195bd27a1b313649e6f9_20183_5 with timeout=300
2026-01-25 18:20:02 [debug    ] Buffering IOPub msg (type=status parent_id=369895d3-a9bd195bd27a1b313649e6f9_20183_3) - known exec keys: ['369895d3-a9bd195bd27a1b313649e6f9_20183_5'] (len=1)
2026-01-25 18:20:02 [debug    ] Buffering IOPub msg (type=stream parent_id=369895d3-a9bd195bd27a1b313649e6f9_20183_3) - known exec keys: ['369895d3-a9bd195bd27a1b313649e6f9_20183_5'] (len=1)
Finalizing 369895d3-a9bd195bd27a1b313649e6f9_20183_5 status=completed cell_index=0
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: d144a3f8-0dd6-440e-8a11-c553acd139cc
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw2/test_multiple_asset_types0/test_multi_assets.ipynb (PID: 21510)
--------------------------- Captured stdout teardown ---------------------------
2026-01-25 18:20:03 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw2/test_multiple_asset_types0/test_multi_assets.ipynb
2026-01-25 18:20:04 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw2/test_multiple_asset_types0/test_multi_assets.ipynb
_______________________ test_variable_manifest_populates _______________________
[gw7] linux -- Python 3.12.10 /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/bin/python

tmp_path = PosixPath('/tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0')

    @pytest.mark.asyncio
    @pytest.mark.integration
    async def test_variable_manifest_populates(tmp_path: Path):
        test_nb = tmp_path / "test_var_dashboard.ipynb"
        nb = nbformat.v4.new_notebook()
        nb.cells = [
            nbformat.v4.new_code_cell("x = 42"),
            nbformat.v4.new_code_cell("message = 'Hello World'"),
            nbformat.v4.new_code_cell("data = [1, 2, 3, 4, 5]"),
        ]
        nbformat.write(nb, test_nb)
    
        sm = SessionManager()
        try:
            await sm.start_kernel(str(test_nb))
            # Execute cells
            for i, cell in enumerate(nb.cells):
                task_id = await sm.execute_cell_async(str(test_nb), i, cell.source)
                # Wait for completion
                for _ in range(200):  # up to ~20s
                    status = sm.get_execution_status(str(test_nb), task_id)
                    if status.get("status") in {"completed", "error"}:
                        break
                    await asyncio.sleep(0.1)
    
            # Collect manifest (with retry for timing issues)
            manifest_code = _build_manifest_code()
            manifest = []
            for attempt in range(3):
                output = await sm.run_simple_code(str(test_nb), manifest_code)
                if output and not output.startswith("Error"):
                    try:
                        manifest = _extract_manifest_from_sanitized(output)
                        if manifest:  # Successfully extracted
                            break
                    except json.JSONDecodeError:
                        pass  # Retry
                await asyncio.sleep(0.5)
    
>           assert (
                manifest
            ), f"Failed to extract manifest after retries. Last output: {output!r}"
E           AssertionError: Failed to extract manifest after retries. Last output: '[INTEGRITY WARNING] Cell 0 executed out-of-order; highest executed Cell 3. This may indicate hidden state has been relied upon.{"llm_summary": "[{\\"name\\":\\"original_ps1\\",\\"type\\":\\"str\\",\\"size\\":\\"45 B\\"},{\\"name\\":\\"is_wsl\\",\\"type\\":\\"bool\\",\\"size\\":\\"28 B\\"},{\\"name\\":\\"x\\",\\"type\\":\\"int\\",\\"size\\":\\"28 B\\"},{\\"name\\":\\"message\\",\\"type\\":\\"str\\",\\"size\\":\\"52 B\\"},{\\"name\\":\\"data\\",\\"type\\":\\"list\\",\\"size\\":\\"104 B\\"}]\\n", "raw_outputs": [{"output_type": "stream", "metadata": {}, "name": "stdout", "text": "[{\\"name\\":\\"original_ps1\\",\\"type\\":\\"str\\",\\"size\\":\\"45 B\\"},{\\"name\\":\\"is_wsl\\",\\"type\\":\\"bool\\",\\"size\\":\\"28 B\\"},{\\"name\\":\\"x\\",\\"type\\":\\"int\\",\\"size\\":\\"28 B\\"},{\\"name\\":\\"message\\",\\"type\\":\\"str\\",\\"size\\":\\"52 B\\"},{\\"name\\":\\"data\\",\\"type\\":\\"list\\",\\"size\\":\\"104 B\\"}]\\n"}]}'
E           assert []

tests/test_variable_dashboard_integration.py:138: AssertionError
----------------------------- Captured stdout call -----------------------------
2026-01-25 18:20:03 [info     ] KernelLifecycle initialized (max_concurrent=10)
2026-01-25 18:20:03 [info     ] IOMultiplexer initialized (input_timeout=60s)
2026-01-25 18:20:03 [info     ] [KERNEL] Assigning UUID: a89f8452-b82e-45ad-b627-5720492b89c3
2026-01-25 18:20:03 [info     ] [KERNEL] Started /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb cwd=/tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0 docker=False env=system
2026-01-25 18:20:06 [info     ] Starting IOPub listener for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
2026-01-25 18:20:06 [info     ] Starting stdin listener for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
Waiting for status change on 20f0ffb6-9fa77ab89727abdae575e2db_20198_4 with timeout=300
2026-01-25 18:20:06 [debug    ] Buffering IOPub msg (type=status parent_id=20f0ffb6-9fa77ab89727abdae575e2db_20198_2) - known exec keys: ['20f0ffb6-9fa77ab89727abdae575e2db_20198_4'] (len=1)
2026-01-25 18:20:06 [debug    ] Buffering IOPub msg (type=stream parent_id=20f0ffb6-9fa77ab89727abdae575e2db_20198_2) - known exec keys: ['20f0ffb6-9fa77ab89727abdae575e2db_20198_4'] (len=1)
Finalizing 20f0ffb6-9fa77ab89727abdae575e2db_20198_4 status=completed cell_index=0
Waiting for status change on 20f0ffb6-9fa77ab89727abdae575e2db_20198_5 with timeout=300
Finalizing 20f0ffb6-9fa77ab89727abdae575e2db_20198_5 status=completed cell_index=1
Waiting for status change on 20f0ffb6-9fa77ab89727abdae575e2db_20198_6 with timeout=300
2026-01-25 18:20:07 [debug    ] Buffering IOPub msg (type=status parent_id=20f0ffb6-9fa77ab89727abdae575e2db_20198_2) - known exec keys: ['20f0ffb6-9fa77ab89727abdae575e2db_20198_4', '20f0ffb6-9fa77ab89727abdae575e2db_20198_5', '20f0ffb6-9fa77ab89727abdae575e2db_20198_6'] (len=3)
2026-01-25 18:20:07 [debug    ] Buffering IOPub msg (type=status parent_id=20f0ffb6-9fa77ab89727abdae575e2db_20198_3) - known exec keys: ['20f0ffb6-9fa77ab89727abdae575e2db_20198_4', '20f0ffb6-9fa77ab89727abdae575e2db_20198_5', '20f0ffb6-9fa77ab89727abdae575e2db_20198_6'] (len=3)
2026-01-25 18:20:07 [debug    ] Buffering IOPub msg (type=status parent_id=20f0ffb6-9fa77ab89727abdae575e2db_20198_3) - known exec keys: ['20f0ffb6-9fa77ab89727abdae575e2db_20198_4', '20f0ffb6-9fa77ab89727abdae575e2db_20198_5', '20f0ffb6-9fa77ab89727abdae575e2db_20198_6'] (len=3)
Finalizing 20f0ffb6-9fa77ab89727abdae575e2db_20198_6 status=completed cell_index=2
Waiting for status change on 20f0ffb6-9fa77ab89727abdae575e2db_20198_7 with timeout=300
Finalizing 20f0ffb6-9fa77ab89727abdae575e2db_20198_7 status=completed cell_index=-1
Waiting for status change on 20f0ffb6-9fa77ab89727abdae575e2db_20198_8 with timeout=300
Finalizing 20f0ffb6-9fa77ab89727abdae575e2db_20198_8 status=completed cell_index=-1
Waiting for status change on 20f0ffb6-9fa77ab89727abdae575e2db_20198_9 with timeout=300
Finalizing 20f0ffb6-9fa77ab89727abdae575e2db_20198_9 status=completed cell_index=-1
2026-01-25 18:20:10 [info     ] IOPub listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
2026-01-25 18:20:10 [info     ] Stdin listener cancelled for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
2026-01-25 18:20:11 [info     ] [KERNEL] Stopped /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
------------------------------ Captured log call -------------------------------
INFO     src.observability:observability.py:16 Max concurrent kernels: 10
INFO     src.observability:observability.py:16 Scheduled restore of persisted sessions on startup
INFO     src.observability:observability.py:16 [OPS] Continuous asset pruner started (interval: 1h)
INFO     src.observability:observability.py:16 Starting Asset Cleanup task (scan interval: 3600s)
INFO     src.observability:observability.py:16 [KERNEL] Assigning UUID: 1fe7146b-fd70-4ec1-bafe-2f524e47a484
INFO     src.observability:observability.py:16 Autoreload and visualization config sent to kernel
INFO     src.observability:observability.py:16 Path setup sent to kernel
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 21716)
INFO     src.observability:observability.py:16 Finalize exec c1927104-50ed-4c34-b58b-8a2e5489bbb9 text_summary len: 38
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 21716)
INFO     src.observability:observability.py:16 Finalize exec 64ff5dc9-0d45-49b5-98df-186b045465d2 text_summary len: 38
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 21716)
INFO     src.observability:observability.py:16 Finalize exec a9fb59f6-5427-4fc9-b534-f1b2a6b4f7d1 text_summary len: 38
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 21716)
INFO     src.observability:observability.py:16 Finalize exec f4978741-c904-4dd8-abf0-beda2baec8fe text_summary len: 818
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 21716)
INFO     src.observability:observability.py:16 Finalize exec 9f5be008-2c57-4aed-abec-4f40b963a1dc text_summary len: 818
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 21716)
ERROR    opentelemetry.exporter.otlp.proto.grpc.exporter:exporter.py:416 Failed to export traces to localhost:4317, error code: StatusCode.UNAVAILABLE
WARNING  opentelemetry.exporter.otlp.proto.grpc.exporter:exporter.py:424 Transient error StatusCode.UNAVAILABLE encountered while exporting traces to localhost:4317, retrying in 1.09s.
INFO     src.observability:observability.py:16 Finalize exec 3ac89472-ea00-452c-905f-d563860b9c25 text_summary len: 818
WARNING  src.kernel_state:kernel_state.py:112 Lock already held for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb
INFO     src.kernel_state:kernel_state.py:97 Persisted session info for /tmp/pytest-of-david/pytest-126/popen-gw7/test_variable_manifest_populat0/test_var_dashboard.ipynb (PID: 21716)
INFO     src.observability:observability.py:16 [ASSET CLEANUP] Prune result: Deleted 0 orphaned assets (0 bytes), kept 0 referenced assets
=============================== warnings summary ===============================
src/config.py:13: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/src/config.py:13: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    PORT: int = Field(8000, ge=1024, le=65535, env="MCP_PORT")

src/config.py:14: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/src/config.py:14: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    LOG_LEVEL: Literal["debug", "info", "warning", "error", "critical"] = Field(

tests/test_e2e.py:8: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/tests/test_e2e.py:8: PytestUnknownMarkWarning: Unknown pytest.mark.e2e - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.e2e

tests/test_variable_dashboard_integration.py:100: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/tests/test_variable_dashboard_integration.py:100: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

tests/test_variable_dashboard_integration.py:150: 10 warnings
  /home/david/personal/mcp-server-jupyter/tools/mcp-server-jupyter/tests/test_variable_dashboard_integration.py:150: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

tests/test_git_awareness.py::TestCellIDOperations::test_edit_cell_heals_missing_id_using_expected_index
tests/test_git_awareness.py::TestCellIDOperations::test_delete_cell_heals_missing_id_using_expected_index
  /home/david/.cache/pypoetry/virtualenvs/mcp-server-jupyter-I6mhTYSU-py3.12/lib/python3.12/site-packages/nbformat/__init__.py:132: MissingIDFieldWarning: Cell is missing an id field, this will become a hard error in future nbformat versions. You may want to use `normalize()` on your notebooks before validations (available since nbformat 5.1.4). Previous versions of nbformat are fixing this issue transparently, and will stop doing so in the future.
    validate(nb)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_comprehensive_async.py::test_cwd_is_notebook_dir - assert '...
FAILED tests/test_real_world.py::test_inspect_variable_integration - json.dec...
FAILED tests/test_security_fixes.py::TestHTMLTableIntegration::test_small_dataframe_shows_inline
FAILED tests/test_real_world.py::test_autoreload_enabled_on_startup - Asserti...
FAILED tests/test_real_world.py::test_multiple_asset_types - AssertionError: ...
FAILED tests/test_variable_dashboard_integration.py::test_variable_manifest_populates
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 6 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!! xdist.dsession.Interrupted: stopping after 5 failures !!!!!!!!!!!!!
6 failed, 619 passed, 7 skipped, 52 warnings in 159.25s (0:02:39)
