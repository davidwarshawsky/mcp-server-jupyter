# ==============================================================================
# MCP Jupyter Demo Recording Environment - Docker Compose
# ==============================================================================
#
# Runs code-server in isolation for Playwright demo recordings.
#
# Usage:
#   docker compose up -d          # Start container
#   docker compose down           # Stop container
#   docker compose down -v        # Stop and remove volumes (fresh start)
#   docker compose logs -f        # View logs
#   docker compose restart        # Restart (after installing extensions)
#
# Access: http://localhost:8443
#
# Last Updated: 2026-01-22
# ==============================================================================

services:
  code-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: demo-code-server-custom:latest
    container_name: demo-code-server
    
    # User/Group settings (LinuxServer.io convention)
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      # Disable authentication entirely for demo recording
      - PASSWORD=
      - HASHED_PASSWORD=
      # Set default workspace
      - DEFAULT_WORKSPACE=/config/workspace
      # Python settings
      - PYTHONUNBUFFERED=1
    
    volumes:
      # VS Code settings - needs to be writable
      - ./automation-config/settings.json:/config/data/User/settings.json
      
      # Demo notebook (read-only to prevent accidental changes)
      - ../../demo.ipynb:/config/workspace/demo.ipynb:ro
      
      # Persist extensions across restarts (avoids reinstall)
      - code-server-extensions:/config/extensions
      
      # Persist VS Code data (settings, global storage, etc.)
      - code-server-data:/config/data
    
    ports:
      - "8443:8443"
    
    # Resource limits for predictable performance
    mem_limit: 4g
    cpus: 2.0
    
    # Larger shared memory for browser-like operations
    shm_size: 2gb
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8443"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Named volumes for persistence
volumes:
  code-server-extensions:
    name: demo-code-server-extensions
  code-server-data:
    name: demo-code-server-data
